<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Мой Marketplace</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js"></script>
</head>
<body>

<!-- Регистрация -->
<form id="registerForm">
  <input id="username" placeholder="Имя" required>
  <input id="email" type="email" placeholder="Email" required>
  <input id="password" type="password" placeholder="Пароль" required>
  <select id="role">
    <option value="client">Клиент</option>
    <option value="artist">Артист</option>
    <option value="admin">Админ</option>
  </select>
  <button type="submit">Зарегистрироваться</button>
</form>

<!-- Вход -->
<form id="loginForm">
  <input id="loginEmail" type="email" placeholder="Email" required>
  <input id="loginPassword" type="password" placeholder="Пароль" required>
  <button type="submit">Войти</button>
</form>

<button id="logoutBtn" style="display:none">Выйти</button>

<!-- Кабинет пользователя, заявки, чат, админ-панель -->
<div id="cabinetContainer"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB5a2nUB_buM9Sg_1RbUCmzIYCiTEYucSY",
  authDomain: "palan-hype.firebaseapp.com",
  projectId: "palan-hype",
  storageBucket: "palan-hype.firebasestorage.app",
  messagingSenderId: "982646795947",
  appId: "1:982646795947:web:4a12ed6c81e0caf6fdd1ee",
  measurementId: "G-CZBTBEYR7P"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Регистрация
const registerForm = document.getElementById('registerForm');
if (registerForm) {
  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = registerForm.username.value.trim();
    const email = registerForm.email.value.trim();
    const password = registerForm.password.value;
    const role = registerForm.role.value;
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      await db.collection('users').doc(cred.user.uid).set({
        username, email, role, created: Date.now()
      });
      alert('Регистрация успешна. Теперь вы можете войти.');
    } catch (err) {
      alert('Ошибка регистрации: ' + err.message);
    }
  });
}

// Вход
const loginForm = document.getElementById('loginForm');
if (loginForm) {
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = loginForm.loginEmail.value.trim();
    const password = loginForm.loginPassword.value;
    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch (err) {
      alert('Ошибка входа: ' + err.message);
    }
  });
}

// Выход
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', () => auth.signOut());
}

// Кабинет, заявки, чат, редактор профиля, админ-панель
const cabinetContainer = document.getElementById('cabinetContainer');
auth.onAuthStateChanged(async (user) => {
  if (!cabinetContainer) return;
  if (user) {
    if (logoutBtn) logoutBtn.style.display = 'inline-block';

    // Получаем профиль
    const snap = await db.collection('users').doc(user.uid).get();
    const profile = snap.exists ? snap.data() : { username: user.email, role: 'client', email: user.email };

    cabinetContainer.innerHTML = `
      <div id="cabinet" style="border:1px solid #ccd;padding:10px;margin:10px;">
        <h2>Личный кабинет</h2>
        <b>Имя:</b> <span id="cabUsername">${profile.username || ''}</span><br>
        <b>Email:</b> ${profile.email || user.email}<br>
        <b>Роль:</b> ${profile.role || 'client'}<br>
        <img id="profilePhoto" src="${profile.photo||''}" style="max-width:80px;max-height:80px;">
        <br>VK: <a href="${profile.vk||'#'}" target="_blank">${profile.vk||''}</a>
        <br>Telegram: <a href="https://t.me/${(profile.telegram||'').replace('@','')}" target="_blank">${profile.telegram||''}</a>
        <br>
        <hr>
        <form id="profileEditForm">
          <h4>Редактировать профиль</h4>
          <input id="photoEdit" placeholder="URL фото" value="${profile.photo||''}">
          <input id="vkEdit" placeholder="VK" value="${profile.vk||''}">
          <input id="tgEdit" placeholder="Telegram" value="${profile.telegram||''}">
          <button>Сохранить профиль</button>
        </form>
        <div id="profileEditStatus"></div>
        <hr>
        <form id="appForm">
          <h4>Создать заявку</h4>
          <input id="appType" placeholder="Тип (DJ/ведущий/освещение)" required>
          <input id="appDate" type="date" required>
          <input id="appBudget" type="number" placeholder="Бюджет (руб)" required>
          <input id="appContact" placeholder="Контакт" required>
          <textarea id="appDetails" placeholder="Описание"></textarea>
          <button type="submit">Отправить заявку</button>
        </form>
        <div id="appStatus"></div>
        <hr>
        <h4>Мои заявки</h4>
        <div id="myApps"></div>
        <hr>
        <form id="msgForm">
          <h4>Чат</h4>
          <input id="msgText" placeholder="Сообщение">
          <button>Отправить</button>
        </form>
        <div id="chat"></div>
        <div id="adminPanel"></div>
      </div>
    `;

    // Редактирование профиля
    document.getElementById('profileEditForm').onsubmit = async (e) => {
      e.preventDefault();
      const photo = document.getElementById('photoEdit').value;
      const vk = document.getElementById('vkEdit').value;
      const telegram = document.getElementById('tgEdit').value;
      try {
        await db.collection('users').doc(user.uid).update({ photo, vk, telegram });
        document.getElementById('profileEditStatus').textContent = 'Сохранено!';
        document.getElementById('profilePhoto').src = photo;
      } catch (err) {
        document.getElementById('profileEditStatus').textContent = 'Ошибка: ' + err.message;
      }
    };

    // Заявка
    document.getElementById('appForm').onsubmit = async (e) => {
      e.preventDefault();
      const type = document.getElementById('appType').value.trim();
      const date = document.getElementById('appDate').value;
      const budget = Number(document.getElementById('appBudget').value || 0);
      const contact = document.getElementById('appContact').value.trim();
      const details = document.getElementById('appDetails').value.trim();
      try {
        await db.collection('applications').add({
          uid: user.uid,
          username: profile.username || user.email,
          type, date, budget, contact, details,
          status: 'Новая',
          created: Date.now()
        });
        document.getElementById('appStatus').textContent = 'Заявка отправлена!';
        e.target.reset();
        loadMyApps(user.uid);
      } catch (err) {
        document.getElementById('appStatus').textContent = 'Ошибка: ' + err.message;
      }
    };

    // Мои заявки
    loadMyApps(user.uid);
    async function loadMyApps(uid) {
      const box = document.getElementById('myApps');
      box.innerHTML = 'Загрузка...';
      const q = await db.collection('applications').where('uid', '==', uid).orderBy('created', 'desc').get();
      box.innerHTML = '';
      if (q.empty) { box.innerHTML = '<i>Нет заявок.</i>'; return; }
      let arr = [];
      q.forEach(doc => {
        const a = doc.data();
        arr.push(`<div style="border:1px solid #ddd;padding:8px;margin:6px;">
            <b>${a.type}</b> — ${a.date} — ${a.status}<br>
            Бюджет: ${a.budget} руб<br>
            Контакт: ${a.contact}<br>
            <i>${a.details}</i>
          </div>`);
      });
      box.innerHTML = arr.join('');
    }

    // Чат
    document.getElementById('msgForm').onsubmit = async (e) => {
      e.preventDefault();
      const text = document.getElementById('msgText').value;
      await db.collection('messages').add({
        uid: user.uid,
        username: profile.username || user.email,
        text, created: Date.now()
      });
      document.getElementById('msgText').value = '';
      loadChat();
    };
    async function loadChat() {
      const q = await db.collection('messages').orderBy('created', 'desc').limit(20).get();
      let html = '';
      q.forEach(doc => { const m = doc.data(); html += `<div><b>${m.username}:</b> ${m.text}</div>`; });
      document.getElementById('chat').innerHTML = html;
    }
    loadChat();

    // Панель админа (просмотр всех заявок)
    if (profile.role === 'admin') {
      showAllApplications();
    }
    async function showAllApplications() {
      const q = await db.collection('applications').orderBy('created', 'desc').get();
      const adminPanel = document.getElementById('adminPanel');
      let html = '<h3>Все заявки (для админа):</h3>';
      q.forEach(doc => {
        const a = doc.data();
        html += `<div style="border:1px solid #ccc; padding:6px; margin:5px;">
          <b>${a.type}</b> — ${a.date} — <b>статус:${a.status || 'Новая'}</b><br>
          <b>Заказчик:</b> ${a.username} <br>
          <b>Контакт:</b> ${a.contact}<br>
          <b>Описание:</b> ${a.details}
        </div>`;
      });
      adminPanel.innerHTML = html;
    }
  } else {
    if (logoutBtn) logoutBtn.style.display = 'none';
    cabinetContainer.innerHTML = '';
  }
});
</script>
</body>
</html>
